# Monorepo Structure & Setup Overview

This document captures the repo layout, core tooling, and conventions
for a stable, TypeScript‑first monorepo using pnpm workspaces. It is the
single source of truth for where code lives and how it is wired together.

## High‑Level Decisions

- Workspace: pnpm workspaces + Turborepo for pipelines/cache.
- Language: TypeScript everywhere, ESM modules across all packages/apps.
- Type safety: Strict TS, no `any`, `allowImportingTsExtensions: true`.
- Lint/format: oxlint + Prettier (no ESLint).
- Testing: Vitest (workspace config).
- Backend: Hono + tsx for dev, tsdown for prod builds.
- DB: MikroORM + Postgres using defineEntity; MikroORM migrations; DB local to backend.
- Queues: BullMQ + Redis.
- Contracts: orpc + zod schemas/routers as a buildable package.
- Frontend: Vite + React + TanStack Router + TanStack Query + Retro UI.
- Env: project‑scoped `.env` files only; `.env.example` committed.
- CI: GitHub Actions (pnpm + turbo cache) running lint → typecheck → test → build.

## Directory Layout

```
.
├─ backend/                     # Single backend app (Hono)
│  ├─ src/
│  │  ├─ app.ts                 # Hono app wiring
│  │  ├─ index.ts               # Bootstrap server (tsx in dev)
│  │  ├─ routes/                # HTTP routes (thin)
│  │  ├─ orpc/                  # orpc handlers bound to contracts
│  │  ├─ integrations/
│  │  │  ├─ github/             # webhook verification + handlers
│  │  │  └─ slack/              # events + slash commands
│  │  ├─ queues/                # BullMQ queues/processors
│  │  ├─ db/                    # MikroORM entities + data access
│  │  └─ config/                # zod‑validated env
│  ├─ migrations/               # SQL migrations (generated by MikroORM)
│  ├─ mikro-orm.config.ts       # MikroORM config
│  └─ .env.example
│
├─ contracts/                   # Shared orpc routers + zod schemas
│  └─ src/
│     ├─ shared/                # primitives, errors, cross‑cutting schemas
│     ├─ frontend/
│     │  ├─ landing-page/
│     │  ├─ admin-app/
│     │  └─ user-app/
│     ├─ backend/
│     └─ integrations/
│        ├─ github/
│        └─ slack/
│
├─ frontend/
│  ├─ landing_page/             # Vite + React + TanStack + Retro UI
│  │  └─ .env.example
│  ├─ admin_app/
│  │  └─ .env.example
│  └─ user_app/
│     └─ .env.example
│
├─ packages/                    # Shared internal libraries
│  ├─ tsconfig/                 # Shared tsconfig presets
│  ├─ logger/                   # pino‑based logger
│  └─ ui/                       # shared UI components
│
├─ infra/
│  └─ docker-compose.yml        # Postgres + Redis for local dev
│
├─ docs/                        # ADRs, runbooks, architecture notes
├─ scripts/                     # bootstrap/build/test helpers
├─ pnpm-workspace.yaml          # workspace globs
├─ tsconfig.base.json           # strict base config (NodeNext)
├─ turbo.json                   # build/test/lint pipelines
├─ vitest.workspace.ts          # unified test workspace
└─ .tool-versions               # Node + pnpm versions (asdf)
```

### Rationale by Area

- backend: Single process for simplicity. Clear subfolders allow lifting a
  bounded context into its own service later (integrations, queues) without
  churn.
- contracts: Acts as the shared API surface. orpc contracts + zod schemas are
  versioned and consumed by all apps. Keep it dependency‑light and fast to
  build.
- frontend: Each app is isolated with its own `.env` and Vite config. Shared
  UI lives in `packages/ui` when it proves reusable.
- packages: Contain reusable code (logger, ui). Keeping these granular
  prevents duplication across apps.
- infra: Local dev dependencies (Postgres, Redis) run via one docker compose
  file; keeps system installs minimal.

### Database Design Policy

- No database‑level foreign keys. We model relations in entities but avoid
  creating FK constraints in migrations. Referential integrity is enforced in
  application code and via business logic (e.g., cascade deletes/validation in
  repositories/services). Configure MikroORM to not create FK constraints in
  schema generation/migrations.

## Workspace Globs

pnpm recognizes these projects via `pnpm-workspace.yaml`:

```
packages:
  - backend
  - contracts
  - frontend/*
  - packages/*
```

## Module, TS, and Imports Policy

- ESM everywhere: all `package.json` files use `"type": "module"`.
- TypeScript uses `module: "NodeNext"` and `moduleResolution: "NodeNext"`.
- Strict config: `strict: true`, `noImplicitAny: true`,
  `noUncheckedIndexedAccess: true`, `exactOptionalPropertyTypes: true`,
  `noImplicitOverride: true`, `useUnknownInCatchVariables: true`.
- `allowImportingTsExtensions: true` is enabled so dev entrypoints can run via
  `tsx` with explicit `.ts` extension imports when desired.
- Build outputs are ESM with type declarations (via `tsdown`). Apps import built
  packages by their workspace package names (preferred) rather than TS path
  aliases to avoid bundler drift.

## Linting and Formatting

- oxlint is the primary linter; Prettier for formatting only.
- Workspace‑wide rules enforce zero `any`, safe promises, import hygiene, and
  consistent style.

## Testing

- Vitest with a workspace file drives tests across all projects. Aim for
  ≥60% line coverage on changed code. Tests live next to sources as
  `*.test.ts`.

## Environment and Secrets

- No root `.env`. Each project maintains its own `.env` and `.env.example`.
- Define all expected variables in zod per‑project and fail fast on boot.

### Encrypted Env Policy

- Commit only encrypted env files; never commit plaintext `.env`.
- Recommended: SOPS + age (single private key as the only secret).
    - Per project, commit `*.env.enc` and decrypt locally/CI.
    - Local: `sops -d backend/.env.enc > backend/.env`.
    - CI: store `SOPS_AGE_KEY` and decrypt before build/test.
- Alternative: Dotenv Vault (commit `.env.vault`, use `DOTENV_KEY`).
- Frontends: treat env as public config only; never store secrets. Only variables
  prefixed with `VITE_` are exposed to the browser.

Example CI decrypt step (SOPS + age):

```
- name: Decrypt env (backend)
  run: sops -d backend/.env.enc > backend/.env
  env:
    SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
```

## Scaling Later

- If the single backend grows hot spots, split by context (e.g., move
  `integrations/slack` to its own service) with minimal changes due to clear
  folder boundaries and contract‑first design.
